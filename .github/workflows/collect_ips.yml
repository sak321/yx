name: Collect Node IPs

on:
  workflow_dispatch: # 支持手动触发
  schedule:
    - cron: '0 */6 * * *' # 每6小时自动运行一次

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch and Process IPs
        run: |
          # 定义所有接口地址
          URLS=(
            "https://ddx.snu.cc/TW"
            "https://ddx.snu.cc/HK"
            "https://ddx.snu.cc/JP"
            "https://ddx.snu.cc/KR"
            "https://ddx.snu.cc/SG"
            "https://ddx.snu.cc/US"
          )
          
          # 创建临时文件
          touch temp_ips.txt
          
          # 循环抓取内容
          for url in "${URLS[@]}"; do
            echo "Fetching $url..."
            curl -s "$url" >> temp_ips.txt
            echo "" >> temp_ips.txt
          done
          
          # 核心提取逻辑：提取 IP:端口 并去重
          # 这里将结果重定向到你指定的 wuya.txt 文件中
          grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:[0-9]+' temp_ips.txt | sort -u > wuya.txt
          
          echo "Total IPs collected and saved to wuya.txt: $(wc -l < wuya.txt)"

      - name: Commit and Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          # 确保添加的是 wuya.txt
          git add wuya.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update wuya.txt with latest IPs: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

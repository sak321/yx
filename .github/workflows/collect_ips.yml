name: Collect Node IPs

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch and Process IPs
        run: |
          URLS=(
            "https://ddx.snu.cc/TW"
            "https://ddx.snu.cc/HK"
            "https://ddx.snu.cc/JP"
            "https://ddx.snu.cc/KR"
            "https://ddx.snu.cc/SG"
            "https://ddx.snu.cc/US"
          )
          
          touch temp_ips.txt
          
          for url in "${URLS[@]}"; do
            echo "Fetching $url..."
            curl -s "$url" >> temp_ips.txt
            echo "" >> temp_ips.txt
          done
          
          # 【关键修改】：只提取 IP 部分，不带冒号和端口
          # 使用 sed 或 grep 进一步处理，确保只留下纯 IP
          grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}' temp_ips.txt | sort -u > wuya.txt
          
          echo "Total Clean IPs collected: $(wc -l < wuya.txt)"

      - name: Commit and Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add wuya.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update wuya.txt with pure IPs: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

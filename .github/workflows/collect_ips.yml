name: Collect Node IPs

on:
  workflow_dispatch: # 支持手动触发
  schedule:
    - cron: '0 */6 * * *' # 每6小时自动运行一次

jobs:
  collect:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fetch and Process IPs
        run: |
          # 定义所有接口地址
          URLS=(
            "https://ddx.snu.cc/TW"
            "https://ddx.snu.cc/HK"
            "https://ddx.snu.cc/JP"
            "https://ddx.snu.cc/KR"
            "https://ddx.snu.cc/SG"
            "https://ddx.snu.cc/US"
          )
          
          # 创建一个临时文件
          touch raw_ips.txt
          
          # 循环抓取内容
          for url in "${URLS[@]}"; do
            echo "Fetching $url..."
            curl -s "$url" >> raw_ips.txt
            echo "" >> raw_ips.txt # 确保换行
          done
          
          # 核心提取逻辑：
          # 使用 grep 提取符合 xxx.xxx.xxx.xxx:port 格式的内容
          # sort -u 进行去重
          grep -oE '[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}:[0-9]+' raw_ips.txt | sort -u > ip.txt
          
          echo "Total IPs collected: $(wc -l < ip.txt)"

      - name: Commit and Push
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add ip.txt
          # 只有当文件发生变化时才提交，防止工作流报错
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update node IPs: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi

name: Update IP List
on:
  schedule:
    - cron: '0 */6 * * *' # 第 6 行：确保这里是 2 或 4 个空格缩进，且 cron 值有引号
  workflow_dispatch:      

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Process IP with Geo
        run: |
          # 1. 抓取原始数据
          curl -s https://vps789.com/openApi/cfIpTop20 > data_domain.json
          curl -s https://vps789.com/openApi/cfIpApi > data_ip.json
          
          # 2. 执行 Python 优选逻辑
          python3 - <<EOF
          import json, urllib.request, socket, re

          final_list = []
          ip_pattern = re.compile(r'^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$')

          def get_country(target):
              try:
                  host = target.split(':')[0]
                  query_ip = socket.gethostbyname(host)
                  with urllib.request.urlopen(f'http://ip-api.com/json/{query_ip}?fields=countryCode', timeout=3) as resp:
                      return json.loads(resp.read().decode()).get('countryCode', 'UN')
              except:
                  return 'XX'

          # 处理域名 (Top 20)
          try:
              with open('data_domain.json', 'r') as f:
                  d = json.load(f)
                  items = d.get('data', {}).get('good', [])
                  items.sort(key=lambda x: x.get('ydScore', 999))
                  for idx, item in enumerate(items[:2], 1):
                      domain = item.get('ip')
                      country = get_country(domain)
                      final_list.append(f"{domain}# {country}+域名优选{idx}")
          except: pass

          # 处理纯 IP (接口数据结构对齐)
          try:
              with open('data_ip.json', 'r') as f:
                  d = json.load(f)
                  raw_data = d.get('data', {})
                  all_raw_ips = []
                  for cat in ['CM', 'CT', 'CU', 'AllAvg']:
                      all_raw_ips.extend(raw_data.get(cat, []))

                  seen = set()
                  valid_ips = []
                  for i in all_raw_ips:
                      ip = i.get('ip')
                      if ip and ip_pattern.match(ip) and ip not in seen:
                          seen.add(ip)
                          valid_ips.append(i)

                  # 针对移动指标：ydPkgLostRateAvg(丢包)优先，ydLatencyAvg(延迟)次之
                  valid_ips.sort(key=lambda x: (x.get('ydPkgLostRateAvg', 100), x.get('ydLatencyAvg', 999)))

                  needed = 16 - len(final_list)
                  for idx, item in enumerate(valid_ips[:needed], 1):
                      ip = item.get('ip')
                      country = get_country(ip)
                      final_list.append(f"{ip}:443#lyz_{country}_优选{idx}")
          except: pass

          with open('ip.txt', 'w') as f:
              f.write('\n'.join(final_list))
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ip.txt
          git commit -m "Update 16 optimized IPs $(date)" || exit 0
          git push

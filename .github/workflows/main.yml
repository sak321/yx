name: Ultimate Stable IP List (Daily)
on:
  schedule:
    # 每天北京时间凌晨 0:00 (UTC 16:00) 运行一次
    - cron: '0 16 * * *' 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Aggregate All Best IPs
        run: |
          python3 - <<EOF
          import json, urllib.request, socket, re, time

          # 接口配置
          region_urls = {
              "全球": "https://vps789.com/openApi/cheapVpsTop10",
              "美国": "https://vps789.com/openApi/usVpsTop10",
              "香港": "https://vps789.com/openApi/hkVpsTop10",
              "日本": "https://vps789.com/openApi/jpVpsTop10",
              "欧洲": "https://vps789.com/openApi/euVpsTop10",
              "小众": "https://vps789.com/openApi/nicheVpsTop10"
          }
          top20_url = "https://vps789.com/openApi/cfIpTop20"
          api_url = "https://vps789.com/openApi/cfIpApi"

          final_list = []
          seen_ips = set()
          ip_pattern = re.compile(r'^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$')

          def get_country(target):
              try:
                  query_ip = socket.gethostbyname(target.split(':')[0])
                  time.sleep(1) # 增加延迟，彻底避免 API 屏蔽
                  req = urllib.request.Request(f'http://ip-api.com/json/{query_ip}?fields=countryCode')
                  with urllib.request.urlopen(req, timeout=5) as resp:
                      code = json.loads(resp.read().decode()).get('countryCode', 'UN')
                      return code if code else 'UN'
              except: return 'XX'

          def fetch_json(url):
              try:
                  req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req, timeout=15) as resp:
                      return json.loads(resp.read().decode())
              except: return {}

          # 1. 地区接口 (每区选1个最稳的)
          for name, url in region_urls.items():
              data = fetch_json(url).get('data', {}).get('good', [])
              # 0丢包 + ydScore最低
              stable = sorted([i for i in data if i.get('ydPkgLostRate', 1) == 0], key=lambda x: x.get('ydScore', 999))
              if stable:
                  ip = stable[0].get('ip')
                  if ip and ip not in seen_ips:
                      seen_ips.add(ip)
                      tag = "IP" if ip_pattern.match(ip) else "域名"
                      addr = f"{ip}:443" if tag == "IP" else ip
                      final_list.append(f"{addr}# {get_country(ip)}_{name}{tag}")

          # 2. 运营商专项 (三网各选2个，总共6个)
          api_data = fetch_json(api_url).get('data', {})
          net_configs = [("移动", "CM", "yd"), ("电信", "CT", "dx"), ("联通", "CU", "lt")]
          for net_name, key, pref in net_configs:
              items = api_data.get(key, [])
              def sort_key(x):
                  loss = x.get(f'{pref}PkgLostRateAvg') or x.get(f'{pref}PkgLostRate') or 100
                  lat = x.get(f'{pref}LatencyAvg') or x.get(f'{pref}Latency') or 999
                  return (float(loss), float(lat))
              
              sorted_net = sorted(items, key=sort_key)
              count = 0
              for item in sorted_net:
                  ip = item.get('ip')
                  if ip and ip not in seen_ips and ip_pattern.match(ip):
                      seen_ips.add(ip)
                      final_list.append(f"{ip}:443# {get_country(ip)}_{net_name}优选")
                      count += 1
                      if count >= 2: break

          # 3. 综合 Top20 (选4个压轴域名/IP)
          top20 = fetch_json(top20_url).get('data', {}).get('good', [])
          top20_best = sorted(top20, key=lambda x: x.get('avgScore', 999))
          added_t20 = 0
          for item in top20_best:
              ip = item.get('ip')
              if ip and ip not in seen_ips:
                  seen_ips.add(ip)
                  tag = "IP" if ip_pattern.match(ip) else "域名"
                  addr = f"{ip}:443" if tag == "IP" else ip
                  final_list.append(f"{addr}# {get_country(ip)}_综合Top")
                  added_t20 += 1
                  if added_t20 >= 4: break

          with open('ip.txt', 'w') as f:
              f.write('\n'.join(final_list))
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ip.txt
          git commit -m "Daily Update: $(date +'%Y-%m-%d')" || exit 0
          git push

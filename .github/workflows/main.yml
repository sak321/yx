name: Ultimate IP List
on:
  schedule:
    - cron: '0 16 * * *' 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Aggregate All Best IPs
        run: |
          python3 - <<EOF
          import json, urllib.request, socket, re, time

          # 配置 8 个核心接口
          region_urls = {
              "全球": "https://vps789.com/openApi/cheapVpsTop10",
              "美国": "https://vps789.com/openApi/usVpsTop10",
              "香港": "https://vps789.com/openApi/hkVpsTop10",
              "日本": "https://vps789.com/openApi/jpVpsTop10",
              "欧洲": "https://vps789.com/openApi/euVpsTop10",
              "小众": "https://vps789.com/openApi/nicheVpsTop10"
          }
          top20_url = "https://vps789.com/openApi/cfIpTop20"
          api_url = "https://vps789.com/openApi/cfIpApi"

          final_list = []
          seen_ips = set()
          ip_pattern = re.compile(r'^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$')

          def get_country(target):
              try:
                  query_ip = socket.gethostbyname(target.split(':')[0])
                  time.sleep(0.5) 
                  req = urllib.request.Request(f'http://ip-api.com/json/{query_ip}?fields=countryCode')
                  with urllib.request.urlopen(req, timeout=5) as resp:
                      return json.loads(resp.read().decode()).get('countryCode', 'UN')
              except: return 'XX'

          def fetch_json(url):
              try:
                  req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req, timeout=15) as resp:
                      return json.loads(resp.read().decode())
              except: return {}

          # 1. 地区接口：改用接口原生的 avgScore 排序（分越低越好）
          for name, url in region_urls.items():
              data = fetch_json(url).get('data', {}).get('good', [])
              data.sort(key=lambda x: x.get('avgScore', 999))
              if data:
                  ip = data[0].get('ip')
                  if ip and ip not in seen_ips:
                      seen_ips.add(ip)
                      tag = "IP" if ip_pattern.match(ip) else "域名"
                      addr = f"{ip}:443" if tag == "IP" else ip
                      final_list.append(f"{addr}# {get_country(ip)}_{name}")

          # 2. 运营商专项：匹配对应运营商的 Score 字段
          api_data = fetch_json(api_url).get('data', {})
          for net_name, key in [("移动", "CM"), ("电信", "CT"), ("联通", "CU")]:
              items = api_data.get(key, [])
              if not items: items = api_data.get('AllAvg', [])
              score_key = 'ydScore' if key=='CM' else ('dxScore' if key=='CT' else 'ltScore')
              items.sort(key=lambda x: x.get(score_key, 999))
              count = 0
              for item in items:
                  ip = item.get('ip')
                  if ip and ip not in seen_ips and ip_pattern.match(ip):
                      seen_ips.add(ip)
                      final_list.append(f"{ip}:443# {get_country(ip)}_{net_name}")
                      count += 1
                      if count >= 2: break

          # 3. Top20 接口：取前 4 名
          top20 = fetch_json(top20_url).get('data', {}).get('good', [])
          top20.sort(key=lambda x: x.get('avgScore', 999))
          added_t20 = 0
          for item in top20:
              ip = item.get('ip')
              if ip and ip not in seen_ips:
                  seen_ips.add(ip)
                  tag = "IP" if ip_pattern.match(ip) else "域名"
                  addr = f"{ip}:443" if tag == "IP" else ip
                  final_list.append(f"{addr}# {get_country(ip)}_Top20")
                  added_t20 += 1
                  if added_t20 >= 4: break

          with open('ip.txt', 'w') as f:
              f.write('\n'.join(final_list))
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ip.txt
          git commit -m "Aggregated high-connectivity IPs" || exit 0
          git push

name: Update IP List
on:
  schedule:
    - cron: '0 */6 * * *' # 每 6 小时运行一次
  workflow_dispatch:      # 允许手动运行

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Fetch and Process IP with Geo
        run: |
          # 抓取数据
          curl -s https://vps789.com/openApi/cfIpTop20 > data1.json
          curl -s https://vps789.com/openApi/cfIpApi > data2.json
          
          python3 - <<EOF
          import json, urllib.request

          ips = []
          def extract(file):
              try:
                  with open(file, 'r') as f:
                      d = json.load(f)
                      data = d.get('data', {})
                      if isinstance(data, list):
                          for i in data: ips.append(i.get('ip'))
                      elif isinstance(data, dict):
                          for k in ['CT', 'CU', 'CM', 'AllAvg']:
                              for i in data.get(k, []): ips.append(i.get('ip'))
              except: pass

          extract('data1.json')
          extract('data2.json')
          
          # 去重并只取前 50 个
          unique_ips = list(dict.fromkeys([ip for ip in ips if ip]))[:50]
          
          with open('ip.txt', 'w') as f:
              for idx, ip in enumerate(unique_ips, 1):
                  try:
                      # 查询归属地国家代码
                      with urllib.request.urlopen(f'http://ip-api.com/json/{ip}?fields=countryCode', timeout=3) as response:
                          geo_data = json.loads(response.read().decode())
                          country = geo_data.get('countryCode', 'UN')
                  except:
                      country = 'XX'
                      
                  # 写入文件，格式：IP:端口#lyz_国家_优选序号
                  f.write(f"{ip}:443#lyz_{country}_优选{idx}\n")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ip.txt
          git commit -m "Update IPs with Geo info every 6h" || exit 0
          git push

name: CFST IP Generator
on:
  schedule:
    - cron: '0 */6 * * *' # 每 6 小时自动更新一次
  workflow_dispatch:      # 允许手动运行

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Aggregate IPs for CFST
        run: |
          python3 - <<EOF
          import urllib.request, re, json

          # 接口配置
          vps_url = "https://vps789.com/openApi/cfIpApi"
          ddx_urls = [
              "https://ddx.snu.cc/TW", "https://ddx.snu.cc/HK",
              "https://ddx.snu.cc/JP", "https://ddx.snu.cc/KR",
              "https://ddx.snu.cc/SG", "https://ddx.snu.cc/US"
          ]

          all_ips = set()

          # 1. 抓取 VPS789 的数据 (取前 50 个性能最好的)
          try:
              with urllib.request.urlopen(vps_url, timeout=10) as resp:
                  data = json.load(resp).get('data', {}).get('AllAvg', [])
                  for i in data[:50]:
                      if i.get('ip'): all_ips.add(i.get('ip'))
          except: print("VPS789 fetch failed")

          # 2. 抓取 DDX 各地区数据
          for url in ddx_urls:
              try:
                  with urllib.request.urlopen(url, timeout=10) as resp:
                      content = resp.read().decode('utf-8')
                      # 使用正则表达式提取纯 IP
                      ips = re.findall(r'\b(?:[0-9]{1,3}\.){3}[0-9]{1,3}\b', content)
                      all_ips.update(ips)
              except: print(f"Failed to fetch {url}")

          # 3. 写入专门给 CFST 用的纯 IP 文件
          with open('cfst_hosts.txt', 'w') as f:
              # 每行一个 IP，不带端口，不带标签
              f.write('\n'.join(sorted(list(all_ips))))
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add cfst_hosts.txt
          git commit -m "Update CFST host list" || exit 0
          git push

name: CFST IP Generator
on:
  schedule:
    - cron: '0 16 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Aggregate All IPs
        run: |
          python3 - <<EOF
          import urllib.request, re

          urls = [
              "https://vps789.com/openApi/cfIpApi",
              "https://vps789.com/openApi/cfIpTop20",
              "https://ddx.snu.cc/TW", 
              "https://ddx.snu.cc/HK",
              "https://ddx.snu.cc/JP", 
              "https://ddx.snu.cc/KR",
              "https://ddx.snu.cc/SG", 
              "https://ddx.snu.cc/US"
          ]

          all_ips = set()
          # 这个正则会抓取所有 1.2.3.4 这种格式的 IP，不管前后带不带端口或文字
          ip_pattern = re.compile(r'(?:[0-9]{1,3}\.){3}[0-9]{1,3}')

          for url in urls:
              try:
                  # 模拟浏览器访问，防止被拦截
                  req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
                  with urllib.request.urlopen(req, timeout=15) as resp:
                      # 将返回的纯文本或 JSON 转化为字符串
                      raw_data = resp.read().decode('utf-8', errors='ignore')
                      # 暴力提取所有 IP
                      found = ip_pattern.findall(raw_data)
                      print(f"URL: {url} | Found: {len(found)} IPs")
                      all_ips.update(found)
              except Exception as e:
                  print(f"Error fetching {url}: {e}")

          # 排序并保存
          # 去除掉重复的和一些奇怪的内网 IP
          sorted_ips = sorted(list(all_ips))
          
          with open('cfst_hosts.txt', 'w') as f:
              f.write('\n'.join(sorted_ips))
          
          print(f"--- Process Finished ---")
          print(f"Total Unique IPs saved: {len(sorted_ips)}")
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add cfst_hosts.txt
          git commit -m "Update CFST host list: $(date)" || exit 0
          git push
